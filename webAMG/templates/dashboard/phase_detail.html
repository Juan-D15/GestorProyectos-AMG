{% extends "base_dashboard.html" %}
{% load static %}

{% block active_projects_class %}bg-[#8a4534]/10 text-[#8a4534]{% endblock %}
{% block page_title %}{{ phase.phase_name }}{% endblock %}
{% block page_subtitle %}Fase {{ phase.phase_number }} de {{ project.project_name }}{% endblock %}

{% block extra_js %}
<script src="{% static 'src/js/projects.js' %}"></script>
<script src="{% static 'src/js/beneficiaries_evidence.js' %}"></script>
<script src="{% static 'src/js/evidences.js' %}"></script>
<script src="{% static 'src/js/phases.js' %}"></script>
{% endblock %}

{% block dashboard_content %}
<div data-project-id="{{ project.id }}" data-phase-id="{{ phase.id }}">
<!-- Botón de regreso -->
<div class="mb-6">
    <a href="{% url 'project_detail' project.id %}" class="inline-flex items-center space-x-2 text-gray-600 hover:text-gray-900 transition-colors">
        <i class="fas fa-arrow-left"></i>
        <span>Volver al Proyecto</span>
    </a>
</div>

<!-- Información de la Fase -->
<div class="bg-white rounded-xl shadow-sm border border-gray-100 mb-6">
    <div class="p-6">
        <div class="flex items-start justify-between mb-4">
            <div>
                <h1 class="text-2xl font-bold text-gray-900">
                    <i class="fas fa-layer-group text-[#8a4534] mr-2"></i>
                    {{ phase.phase_name }}
                </h1>
                <p class="text-sm text-gray-500 mt-1">
                    {{ phase.start_date|date:"d/m/Y" }} {% if phase.end_date and phase.end_date != phase.start_date %} - {{ phase.end_date|date:"d/m/Y" }}{% endif %}
                </p>
            </div>
            <div>
                {% if phase.status == 'pendiente' %}
                    <span class="px-3 py-1 rounded-full text-xs font-medium bg-gray-100 text-gray-700">Pendiente</span>
                {% elif phase.status == 'en_progreso' %}
                    <span class="px-3 py-1 rounded-full text-xs font-medium bg-yellow-100 text-yellow-700">En Progreso</span>
                {% elif phase.status == 'completada' %}
                    <span class="px-3 py-1 rounded-full text-xs font-medium bg-green-100 text-green-700">Completada</span>
                {% elif phase.status == 'cancelada' %}
                    <span class="px-3 py-1 rounded-full text-xs font-medium bg-red-100 text-red-700">Cancelada</span>
                {% endif %}
            </div>
        </div>

        {% if phase.description %}
        <div class="bg-gray-50 rounded-lg p-4 mb-4">
            <h3 class="text-sm font-semibold text-gray-700 mb-2">Descripción</h3>
            <p class="text-gray-600">{{ phase.description }}</p>
        </div>
        {% endif %}

        {% if phase.objectives %}
        <div class="bg-gray-50 rounded-lg p-4 mb-4">
            <h3 class="text-sm font-semibold text-gray-700 mb-2">Objetivos</h3>
            <p class="text-gray-600">{{ phase.objectives }}</p>
        </div>
        {% endif %}

        <!-- Presupuesto de la Fase -->
        <div class="bg-gray-50 rounded-lg p-4 mb-4 border border-gray-200">
            <div class="flex items-center justify-between">
                <h3 class="text-sm font-semibold text-gray-700">
                    <i class="fas fa-dollar-sign text-[#8a4534] mr-2"></i>Presupuesto de la Fase
                </h3>
                {% if phase.budget %}
                    <span class="text-lg font-bold text-[#8a4534]">Q{{ phase.budget|floatformat:2 }}</span>
                {% else %}
                    <span class="text-sm text-gray-400">No asignado</span>
                {% endif %}
            </div>
            {% if phase.budget %}
            <div class="mt-3 grid grid-cols-1 md:grid-cols-3 gap-3">
                <div class="bg-white rounded-lg p-3">
                    <p class="text-xs text-gray-500 mb-1">Estado</p>
                    <p class="text-sm font-medium text-gray-900">
                        {% if phase.progress_percentage == 0 %}
                            No iniciado
                        {% elif phase.progress_percentage < 100 %}
                            En progreso ({{ phase.progress_percentage|floatformat:1 }}%)
                        {% else %}
                            Completado
                        {% endif %}
                    </p>
                </div>
                <div class="bg-white rounded-lg p-3">
                    <p class="text-xs text-gray-500 mb-1">Fecha de Inicio</p>
                    <p class="text-sm font-medium text-gray-900">{{ phase.start_date|date:"d/m/Y" }}</p>
                </div>
                <div class="bg-white rounded-lg p-3">
                    <p class="text-xs text-gray-500 mb-1">Fecha de Fin</p>
                    <p class="text-sm font-medium text-gray-900">
                        {% if phase.end_date %}{{ phase.end_date|date:"d/m/Y" }}{% else %}No definida{% endif %}
                    </p>
                </div>
            </div>
            {% endif %}
        </div>

        <!-- Beneficiarios de la Fase -->
        <div class="bg-gray-50 rounded-lg p-4">
            <h3 class="text-sm font-semibold text-gray-700 mb-3">Beneficiarios ({{ phase_beneficiaries|length }})</h3>
            {% if phase_beneficiaries %}
            <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                {% for beneficiary in phase_beneficiaries %}
                <div class="flex items-center space-x-3 p-3 bg-white rounded-lg border border-gray-200">
                    <div class="w-10 h-10 rounded-full bg-gradient-to-br from-[#8a4534] to-[#334e76] flex items-center justify-center text-white text-sm font-semibold flex-shrink-0">
                        <span>{{ beneficiary.first_name|slice:":1" }}{{ beneficiary.last_name|slice:":1" }}</span>
                    </div>
                    <div class="flex-1 min-w-0">
                        <p class="font-medium text-gray-900 truncate">{{ beneficiary.first_name }} {{ beneficiary.last_name }}</p>
                        <p class="text-xs text-gray-500 truncate">
                            {% if beneficiary.cui_dpi %}DPI: {{ beneficiary.cui_dpi }}{% else %}Sin DPI{% endif %}
                            {% if beneficiary.community %} • {{ beneficiary.community }}{% endif %}
                        </p>
                    </div>
                </div>
                {% endfor %}
            </div>
            {% else %}
            <p class="text-sm text-gray-500">No hay beneficiarios asignados a esta fase.</p>
            {% endif %}
        </div>
    </div>
</div>

<!-- Evidencias de la Fase -->
<div class="bg-white rounded-xl shadow-sm border border-gray-100 p-6">
    <div class="flex items-center justify-between mb-4">
        <h3 class="text-lg font-semibold text-gray-900">
            <i class="fas fa-images text-[#8a4534] mr-2"></i>Evidencias de la Fase
        </h3>
        <button type="button" onclick="openPhaseEvidenceModal()" class="inline-flex items-center space-x-2 px-4 py-2 text-sm font-medium text-white bg-[#8a4534] hover:bg-[#a05240] rounded-lg transition-colors">
            <i class="fas fa-plus"></i>
            <span>Agregar Evidencia</span>
        </button>
    </div>

    <!-- Filtros de evidencias -->
    <div class="bg-gray-50 rounded-lg p-4 mb-4">
        <div class="flex items-center justify-between mb-3">
            <h4 class="text-sm font-medium text-gray-700">
                <i class="fas fa-filter text-[#8a4534] mr-2"></i>Filtrar Evidencias
            </h4>
            <button type="button" onclick="clearEvidenceFilters()" class="text-xs text-[#334e76] hover:text-[#4a6699] transition-colors">
                <i class="fas fa-times mr-1"></i>Limpiar filtros
            </button>
        </div>
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
            <!-- Filtro por año -->
            <div>
                <label class="block text-xs font-medium text-gray-600 mb-1">Año</label>
                <input type="text" id="evidenceFilterYear" oninput="applyEvidenceFilters()" placeholder="Ej: 2024" maxlength="4" class="w-full px-3 py-2 text-sm border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-[#8a4534]/20 focus:border-[#8a4534]" pattern="[0-9]*" inputmode="numeric">
            </div>
            <!-- Filtro fecha inicio -->
            <div>
                <label class="block text-xs font-medium text-gray-600 mb-1">Fecha Inicio (desde)</label>
                <input type="date" id="evidenceFilterStartDate" oninput="applyEvidenceFilters()" class="w-full px-3 py-2 text-sm border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-[#8a4534]/20 focus:border-[#8a4534]">
            </div>
            <!-- Filtro fecha fin -->
            <div>
                <label class="block text-xs font-medium text-gray-600 mb-1">Fecha Fin (hasta)</label>
                <input type="date" id="evidenceFilterEndDate" oninput="applyEvidenceFilters()" class="w-full px-3 py-2 text-sm border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-[#8a4534]/20 focus:border-[#8a4534]">
            </div>
        </div>
    </div>
    {% if evidences %}
    <div id="evidencesList" class="space-y-4">
        {% for evidence in evidences %}
        <div class="border border-gray-200 rounded-lg p-4 evidence-card"
                data-evidence-id="{{ evidence.id }}"
                data-start-date="{{ evidence.start_date|date:'Y-m-d' }}"
                data-end-date="{{ evidence.end_date|date:'Y-m-d' }}"
                data-start-year="{{ evidence.start_date|date:'Y' }}"
                data-end-year="{{ evidence.end_date|date:'Y' }}">
            <div class="flex items-start justify-between mb-3">
                <div>
                    <h4 class="font-medium text-gray-900">
                        <i class="fas fa-calendar-alt text-[#8a4534] mr-2"></i>
                        {{ evidence.start_date|date:"d/m/Y" }} {% if evidence.end_date != evidence.start_date %} - {{ evidence.end_date|date:"d/m/Y" }}{% endif %}
                    </h4>
                </div>
                <div class="flex items-center space-x-2">
                    <button type="button"
                            data-evidence-id="{{ evidence.id }}"
                            data-start-date="{{ evidence.start_date|date:'Y-m-d' }}"
                            data-end-date="{{ evidence.end_date|date:'Y-m-d' }}"
                            data-description="{{ evidence.description }}"
                            data-created-by="{{ evidence.created_by.full_name|default:'N/A' }}"
                            data-created-at="{{ evidence.created_at|date:'d/m/Y H:i' }}"
                            data-updated-at="{{ evidence.updated_at|date:'d/m/Y H:i' }}"
                            onclick="openPhaseEvidenceDetailsModal(this)"
                            class="text-[#334e76] hover:text-[#4a6694] transition-colors">
                        <i class="fas fa-eye"></i>
                    </button>
                    <button type="button"
                            data-evidence-id="{{ evidence.id }}"
                            data-start-date="{{ evidence.start_date|date:'Y-m-d' }}"
                            data-end-date="{{ evidence.end_date|date:'Y-m-d' }}"
                            data-description="{{ evidence.description }}"
                            onclick="openPhaseEditEvidenceModal(this)"
                            class="text-[#8a4534] hover:text-[#a05240] transition-colors">
                        <i class="fas fa-edit"></i>
                    </button>
                    <button type="button"
                            data-evidence-id="{{ evidence.id }}"
                            onclick="confirmPhaseDeleteEvidence(this)"
                            class="text-red-500 hover:text-red-700 transition-colors">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            </div>
            <p class="text-gray-600 mb-3">{{ evidence.description }}</p>
            {% if evidence.photos.all %}
            <div class="relative">
                {% if evidence.photos.all|length > 6 %}
                    <script>
                        document.addEventListener('DOMContentLoaded', function() {
                            const container = document.getElementById('phase-evidence-photos-{{ evidence.id }}');
                            if (container) {
                                const photos = container.querySelectorAll('.evidence-photo');
                                photos.forEach(function(photo, index) {
                                    if (index >= 6) {
                                        photo.style.display = 'none';
                                    }
                                });
                            }
                        });
                    </script>
                    <button type="button" onclick="navigatePhaseEvidencePhotos('{{ evidence.id }}', -1)" class="absolute left-0 top-1/2 -translate-y-1/2 -translate-x-1/2 z-10 w-8 h-8 bg-white hover:bg-gray-100 rounded-full shadow-lg border border-gray-200 flex items-center justify-center transition-colors">
                        <i class="fas fa-chevron-left text-gray-600"></i>
                    </button>
                    <button type="button" onclick="navigatePhaseEvidencePhotos('{{ evidence.id }}', 1)" class="absolute right-0 top-1/2 -translate-y-1/2 translate-x-1/2 z-10 w-8 h-8 bg-white hover:bg-gray-100 rounded-full shadow-lg border border-gray-200 flex items-center justify-center transition-colors">
                        <i class="fas fa-chevron-right text-gray-600"></i>
                    </button>
                {% endif %}
                {% with total_photos=evidence.photos.all|length %}
                    {% if total_photos == 1 %}
                        <div id="phase-evidence-photos-{{ evidence.id }}" class="grid grid-cols-1 md:grid-cols-1 gap-2">
                    {% elif total_photos == 2 %}
                        <div id="phase-evidence-photos-{{ evidence.id }}" class="grid grid-cols-2 md:grid-cols-2 gap-2">
                    {% elif total_photos == 3 %}
                        <div id="phase-evidence-photos-{{ evidence.id }}" class="grid grid-cols-2 md:grid-cols-3 gap-2">
                    {% elif total_photos == 4 %}
                        <div id="phase-evidence-photos-{{ evidence.id }}" class="grid grid-cols-2 md:grid-cols-2 gap-2">
                    {% elif total_photos >= 5 and total_photos <= 6 %}
                        <div id="phase-evidence-photos-{{ evidence.id }}" class="grid grid-cols-2 md:grid-cols-3 gap-2">
                    {% else %}
                        <div id="phase-evidence-photos-{{ evidence.id }}" class="grid grid-cols-2 md:grid-cols-3 gap-2">
                    {% endif %}
                        {% for photo in evidence.photos.all %}
                            <div class="relative group evidence-photo rounded-xl border-2 border-gray-200 overflow-hidden bg-white shadow-sm hover:shadow-md transition-shadow" data-index="{{ forloop.counter0 }}">
                                <img src="/media/{{ photo.photo_url }}" alt="{{ photo.caption|default:'Foto de evidencia' }}" class="w-full h-32 md:h-36 object-cover cursor-pointer hover:opacity-80 transition-opacity"
                                     data-photo-url="{{ photo.photo_url }}"
                                     data-photo-caption="{{ photo.caption|default:''|escapejs }}"
                                     onclick="openPhotoModal(this)">
                                {% if photo.caption %}
                                    <div class="absolute bottom-0 left-0 right-0 bg-gradient-to-t from-black/70 to-transparent text-white text-xs p-2">
                                        {{ photo.caption }}
                                    </div>
                                {% endif %}
                            </div>
                        {% endfor %}
                    </div>
                {% endwith %}
            </div>
            {% endif %}
        </div>
        {% endfor %}
    </div>
    {% else %}
    <div class="text-center py-8">
        <i class="fas fa-images text-4xl text-gray-300 mb-4"></i>
        <p class="text-gray-500">No hay evidencias agregadas a esta fase.</p>
        <button type="button" onclick="openPhaseEvidenceModal()" class="mt-4 inline-flex items-center space-x-2 px-4 py-2 text-sm font-medium text-[#8a4534] border border-[#8a4534] hover:bg-[#8a4534] hover:text-white rounded-lg transition-colors">
            <i class="fas fa-plus"></i>
            <span>Agregar Evidencia</span>
        </button>
    </div>
    {% endif %}
</div>

<!-- Modal para crear evidencia de fase -->
<div id="phaseEvidenceModal" class="fixed inset-0 bg-black/50 flex items-center justify-center z-50 hidden">
    <div class="bg-white rounded-xl shadow-2xl w-full max-w-4xl mx-4 max-h-[90vh] overflow-y-auto">
        <div class="p-6 border-b border-gray-100 sticky top-0 bg-white z-10">
            <div class="flex items-center justify-between">
                <h3 id="phaseEvidenceModalTitle" class="text-lg font-semibold text-gray-900">Agregar Evidencia a la Fase</h3>
                <button onclick="closePhaseEvidenceModal()" class="text-gray-400 hover:text-gray-600 transition-colors">
                    <i class="fas fa-times text-lg"></i>
                </button>
            </div>
        </div>
        <form id="phaseEvidenceForm" method="post" action="{% url 'phase_evidence_add' project.id phase.id %}" class="p-6 space-y-6" enctype="multipart/form-data">
            {% csrf_token %}
            <input type="hidden" name="evidence_id" id="phaseEvidenceIdInput" value="">
            <input type="hidden" name="photos_to_delete" id="phaseEvidencePhotosToDeleteInput" value="">

            <!-- Fechas -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Fecha de Inicio *</label>
                    <input type="date" name="start_date" required class="w-full px-4 py-2 border border-gray-200 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-[#8a4534]/20 focus:border-[#8a4534]">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Fecha de Fin</label>
                    <input type="date" name="end_date" class="w-full px-4 py-2 border border-gray-200 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-[#8a4534]/20 focus:border-[#8a4534]">
                </div>
            </div>

            <!-- Descripción -->
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Descripción de lo que se hizo *</label>
                <textarea name="description" rows="4" required class="w-full px-4 py-2 border border-gray-200 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-[#8a4534]/20 focus:border-[#8a4534]" placeholder="Describa las actividades realizadas en este periodo..."></textarea>
            </div>

            <!-- Beneficiarios (opcional) -->
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Beneficiarios participantes <span class="text-xs text-gray-500 font-normal">(opcional)</span></label>
                <div class="relative">
                    <button type="button" onclick="openPhaseEvidenceBeneficiariesModal()" class="w-full px-4 py-3 border-2 border-dashed border-gray-300 rounded-lg text-left hover:border-[#8a4534] hover:bg-[#8a4534]/5 transition-all">
                        <div class="flex items-center justify-between">
                            <div class="flex items-center">
                                <i class="fas fa-users text-gray-400 mr-3"></i>
                                <span class="text-sm text-gray-700">Seleccionar beneficiarios...</span>
                            </div>
                            <span id="createPhaseEvidenceBeneficiariesBadge" class="text-xs bg-[#8a4534] text-white px-2 py-1 rounded-full hidden">0 seleccionados</span>
                        </div>
                    </button>
                    <input type="hidden" name="beneficiaries" id="createPhaseEvidenceBeneficiariesInput" value="">
                </div>
            </div>

            <!-- Lista de beneficiarios seleccionados -->
            <div id="createPhaseEvidenceBeneficiariesContainer" class="bg-gray-50 rounded-xl border border-gray-200 p-4 mt-3 mb-6 hidden">
                <h4 class="text-sm font-semibold text-gray-700 mb-3">Beneficiarios seleccionados (<span id="createPhaseEvidenceBeneficiariesCount">0</span>)</h4>
                <div id="createPhaseEvidenceBeneficiariesList" class="space-y-2">
                    <p class="text-sm text-gray-500">No hay beneficiarios seleccionados</p>
                </div>
            </div>

            <!-- Fotos -->
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Fotos de la Evidencia</label>
                <div class="relative">
                    <input type="file" name="photos" id="phaseEvidencePhotosInput" accept="image/*" multiple class="hidden" onchange="previewPhaseEvidencePhotos(this)">
                    <label for="phaseEvidencePhotosInput" class="flex items-center justify-center w-full px-4 py-8 border-2 border-dashed border-gray-300 rounded-lg cursor-pointer hover:border-[#8a4534] hover:bg-[#8a4534]/5 transition-all">
                        <div class="flex flex-col items-center space-y-2">
                            <i class="fas fa-cloud-upload-alt text-3xl text-gray-400"></i>
                            <div class="text-center">
                                <p class="text-sm font-medium text-gray-700">Subir fotos</p>
                                <p class="text-xs text-gray-500">o arrastra y suelta aquí (múltiples)</p>
                            </div>
                        </div>
                    </label>
                </div>
                <div id="phaseEvidencePhotosPreview" class="grid grid-cols-2 md:grid-cols-4 gap-3 mt-4 hidden">
                </div>
            </div>

            <!-- Botones -->
            <div class="flex items-center justify-end space-x-3 pt-4 border-t border-gray-100">
                <button type="button" onclick="closePhaseEvidenceModal()" class="px-6 py-2.5 text-sm font-medium text-gray-700 bg-gray-100 hover:bg-gray-200 rounded-lg transition-colors">
                    Cancelar
                </button>
                <button type="submit" class="px-6 py-2.5 text-sm font-medium text-white bg-[#8a4534] hover:bg-[#a05240] rounded-lg transition-colors">
                    <i class="fas fa-save mr-2"></i>Guardar Evidencia
                </button>
            </div>
        </form>
    </div>
</div>

<!-- Modal de edición de evidencia de fase -->
<div id="editPhaseEvidenceModal" class="fixed inset-0 bg-black/50 flex items-center justify-center z-50 hidden">
    <div class="bg-white rounded-xl shadow-2xl w-full max-w-4xl mx-4 max-h-[90vh] overflow-y-auto">
        <div class="p-6 border-b border-gray-100 sticky top-0 bg-white z-10">
            <div class="flex items-center justify-between">
                <h3 id="editPhaseEvidenceModalTitle" class="text-lg font-semibold text-gray-900">Editar Evidencia</h3>
                <button onclick="closePhaseEditEvidenceModal()" class="text-gray-400 hover:text-gray-600 transition-colors">
                    <i class="fas fa-times text-lg"></i>
                </button>
            </div>
        </div>
        <form id="editPhaseEvidenceForm" method="post" enctype="multipart/form-data" class="p-6 space-y-6">
            {% csrf_token %}
            <input type="hidden" name="evidence_id" id="editEvidenceId" value="">

            <!-- Fechas -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Fecha de Inicio *</label>
                    <input type="date" name="start_date" id="editStartDate" required class="w-full px-4 py-2 border border-gray-200 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-[#8a4534]/20 focus:border-[#8a4534]">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Fecha de Fin</label>
                    <input type="date" name="end_date" id="editEndDate" class="w-full px-4 py-2 border border-gray-200 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-[#8a4534]/20 focus:border-[#8a4534]">
                </div>
            </div>

            <!-- Descripción -->
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Descripción de lo que se hizo *</label>
                <textarea name="description" id="editDescription" rows="4" required class="w-full px-4 py-2 border border-gray-200 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-[#8a4534]/20 focus:border-[#8a4534]" placeholder="Describa las actividades realizadas en este periodo..."></textarea>
            </div>

            <!-- Beneficiarios participantes -->
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Beneficiarios participantes <span class="text-xs text-gray-500 font-normal">(opcional)</span></label>
                <div class="relative">
                    <button type="button" onclick="openPhaseEvidenceBeneficiariesModal()" class="w-full px-4 py-3 border-2 border-dashed border-gray-300 rounded-lg text-left hover:border-[#8a4534] hover:bg-[#8a4534]/5 transition-all">
                        <div class="flex items-center justify-between">
                            <div class="flex items-center">
                                <i class="fas fa-users text-gray-400 mr-3"></i>
                                <span class="text-sm text-gray-700">Seleccionar beneficiarios...</span>
                            </div>
                            <span id="editPhaseEvidenceBeneficiariesBadge" class="text-xs bg-[#8a4534] text-white px-2 py-1 rounded-full hidden">0 seleccionados</span>
                        </div>
                    </button>
                    <input type="hidden" name="beneficiaries" id="editPhaseEvidenceBeneficiariesInput" value="">
                </div>
            </div>

            <!-- Lista de beneficiarios seleccionados -->
            <div id="editPhaseEvidenceBeneficiariesContainer" class="bg-gray-50 rounded-xl border border-gray-200 p-4 mt-3 mb-6 hidden">
                <h4 class="text-sm font-semibold text-gray-700 mb-3">Beneficiarios seleccionados (<span id="editPhaseEvidenceBeneficiariesCount">0</span>)</h4>
                <div id="editPhaseEvidenceBeneficiariesList" class="space-y-2">
                    <p class="text-sm text-gray-500">No hay beneficiarios seleccionados</p>
                </div>
            </div>

            <!-- Nuevas fotos -->
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Nuevas Fotos</label>
                <div class="relative">
                    <input type="file" name="photos" id="editPhaseEvidencePhotosInput" accept="image/*" multiple class="hidden" onchange="previewEditPhaseEvidencePhotos(this)">
                    <label for="editPhaseEvidencePhotosInput" class="flex items-center justify-center w-full px-4 py-8 border-2 border-dashed border-gray-300 rounded-lg cursor-pointer hover:border-[#8a4534] hover:bg-[#8a4534]/5 transition-all">
                        <div class="flex flex-col items-center space-y-2">
                            <i class="fas fa-cloud-upload-alt text-3xl text-gray-400"></i>
                            <div class="text-center">
                                <p class="text-sm font-medium text-gray-700">Subir fotos adicionales</p>
                                <p class="text-xs text-gray-500">o arrastra y suelta aquí (múltiples)</p>
                            </div>
                        </div>
                    </label>
                </div>
                <div id="editPhaseEvidencePhotosPreview" class="grid grid-cols-2 md:grid-cols-4 gap-3 mt-4 hidden">
                </div>
            </div>

            <!-- Fotos existentes -->
            <div>
                <div class="flex items-center justify-between mb-2">
                    <h4 class="text-sm font-medium text-gray-700">Fotos existentes</h4>
                    <p class="text-xs text-gray-500">Marque para eliminar</p>
                </div>
                <div id="editEvidencePhotosContainer" class="grid grid-cols-2 md:grid-cols-4 gap-3">
                    <p class="text-sm text-gray-500 col-span-full">No hay fotos asociadas</p>
                </div>
            </div>
            
            <!-- Botones -->
            <div class="flex items-center justify-end space-x-3 pt-4 border-t border-gray-100">
                <button type="button" onclick="closePhaseEditEvidenceModal()" class="px-6 py-2.5 text-sm font-medium text-gray-700 bg-gray-100 hover:bg-gray-200 rounded-lg transition-colors">
                    Cancelar
                </button>
                <button type="submit" class="px-6 py-2.5 text-sm font-medium text-white bg-[#8a4534] hover:bg-[#a05240] rounded-lg transition-colors">
                    <i class="fas fa-save mr-2"></i>Actualizar Evidencia
                </button>
            </div>
        </form>
    </div>
</div>

<!-- Modal de detalles de evidencia de fase -->
<div id="phaseEvidenceDetailsModal" class="fixed inset-0 bg-black/50 flex items-center justify-center z-50 hidden">
    <div class="bg-white rounded-xl shadow-2xl w-full max-w-4xl mx-4 max-h-[90vh] overflow-y-auto">
        <div class="p-6 border-b border-gray-100 sticky top-0 bg-white z-10">
            <div class="flex items-center justify-between">
                <h3 class="text-lg font-semibold text-gray-900">Detalles de la Evidencia</h3>
                <button onclick="closePhaseEvidenceDetailsModal()" class="text-gray-400 hover:text-gray-600 transition-colors">
                    <i class="fas fa-times text-lg"></i>
                </button>
            </div>
        </div>
        <div class="p-6 space-y-4">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div class="bg-gray-50 rounded-lg p-4">
                    <p class="text-sm text-gray-500 mb-1">Fecha de Inicio</p>
                    <p class="font-medium text-gray-900" id="evidenceDetailStartDate"></p>
                </div>
                <div class="bg-gray-50 rounded-lg p-4">
                    <p class="text-sm text-gray-500 mb-1">Fecha de Fin</p>
                    <p class="font-medium text-gray-900" id="evidenceDetailEndDate"></p>
                </div>
            </div>
            <div class="bg-gray-50 rounded-lg p-4">
                <p class="text-sm text-gray-500 mb-1">Descripción</p>
                <p class="font-medium text-gray-900" id="evidenceDetailDescription"></p>
            </div>

            <!-- Beneficiarios de la evidencia -->
            <div id="evidenceDetailBeneficiariesSection" class="hidden">
                <h4 class="text-sm font-medium text-gray-700 mb-3">Beneficiarios participantes</h4>
                <div id="evidenceDetailBeneficiaries" class="space-y-2">
                </div>
            </div>

            <!-- Fotos de la evidencia -->
            <div id="evidenceDetailPhotosSection" class="hidden">
                <h4 class="text-sm font-medium text-gray-700 mb-3">Fotos</h4>
                <div id="evidenceDetailPhotos" class="grid grid-cols-2 md:grid-cols-3 gap-3">
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal de confirmación para eliminar evidencia de fase -->
<div id="deletePhaseEvidenceModal" class="fixed inset-0 bg-black/50 flex items-center justify-center z-50 hidden">
    <div class="bg-white rounded-xl shadow-2xl w-full max-w-md mx-4 p-6">
        <div class="text-center">
            <div class="w-16 h-16 bg-red-100 rounded-full flex items-center justify-center mx-auto mb-4">
                <i class="fas fa-trash-alt text-red-500 text-2xl"></i>
            </div>
            <h3 class="text-lg font-semibold text-gray-900 mb-2">¿Eliminar Evidencia?</h3>
            <p class="text-gray-600 mb-6">Esta acción eliminará la evidencia y todas sus fotos. ¿Está seguro de que desea continuar?</p>
            <form id="deletePhaseEvidenceFormAction" class="space-y-4">
                {% csrf_token %}
                <input type="hidden" name="evidence_id" id="deletePhaseEvidenceId" value="">
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Contraseña</label>
                    <input type="password" name="password" id="deletePhaseEvidencePassword" required class="w-full px-4 py-2 border border-gray-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-red-500/20 focus:border-red-500" placeholder="Ingrese su contraseña">
                </div>
                <div class="flex items-center justify-center space-x-3">
                    <button type="button" onclick="closeDeletePhaseEvidenceModal()" class="px-4 py-2 text-sm font-medium text-gray-700 bg-gray-100 hover:bg-gray-200 rounded-lg transition-colors">
                        Cancelar
                    </button>
                    <button type="submit" class="px-4 py-2 text-sm font-medium text-white bg-red-500 hover:bg-red-600 rounded-lg transition-colors">
                        Eliminar
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Modal de selección de beneficiarios para evidencia de fase -->
<div id="phaseEvidenceBeneficiariesModal" class="fixed inset-0 bg-black/50 flex items-center justify-center z-50 hidden">
    <div class="bg-white rounded-xl shadow-2xl w-full max-w-2xl mx-4 max-h-[80vh] overflow-hidden flex flex-col">
        <div class="p-6 border-b border-gray-100">
            <div class="flex items-center justify-between">
                <h3 class="text-lg font-semibold text-gray-900">Seleccionar Beneficiarios</h3>
                <button onclick="closePhaseEvidenceBeneficiariesModal()" class="text-gray-400 hover:text-gray-600 transition-colors">
                    <i class="fas fa-times text-lg"></i>
                </button>
            </div>
        </div>
        <div class="p-6 flex-1 overflow-y-auto">
            <div class="mb-4">
                <input type="text" id="phaseEvidenceBeneficiariesSearch" placeholder="Buscar por nombre, DPI o comunidad..." 
                    class="w-full px-4 py-2 border border-gray-200 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-[#8a4534]/20 focus:border-[#8a4534]">
            </div>
            <div class="space-y-2" id="phaseEvidenceBeneficiariesList">
                {% for beneficiary in all_beneficiaries %}
                    <div class="phase-evidence-beneficiary-item flex items-center p-3 bg-gray-50 rounded-lg hover:bg-gray-100 transition-colors" 
                        data-id="{{ beneficiary.id }}" 
                        data-name="{{ beneficiary.full_name }}" 
                        data-dpi="{{ beneficiary.cui_dpi|default:'' }}"
                        data-community="{{ beneficiary.community|default:'' }}">
                         <input type="checkbox" class="w-5 h-5 text-[#8a4534] border-gray-300 rounded focus:ring-[#8a4534] cursor-pointer" value="{{ beneficiary.id }}">
                         <div class="ml-3 flex-1">
                             <p class="text-sm font-medium text-gray-900">{{ beneficiary.full_name }}</p>
                             <p class="text-xs text-gray-500">
                                 {% if beneficiary.cui_dpi %}DPI: {{ beneficiary.cui_dpi }}{% endif %}
                                 {% if beneficiary.community %} • {{ beneficiary.community }}{% endif %}
                             </p>
                         </div>
                    </div>
                {% empty %}
                    <p class="text-sm text-gray-500 text-center py-8">No hay beneficiarios disponibles</p>
                {% endfor %}
            </div>
        </div>
        <div class="p-6 border-t border-gray-100">
            <div class="flex items-center justify-between mb-4">
                <span class="text-sm text-gray-600">Beneficiarios seleccionados: <span id="phaseEvidenceBeneficiariesModalCount" class="font-semibold text-[#8a4534]">0</span></span>
            </div>
            <div class="flex items-center justify-end space-x-3">
                <button type="button" onclick="closePhaseEvidenceBeneficiariesModal()" class="px-6 py-2.5 text-sm font-medium text-gray-700 bg-gray-100 hover:bg-gray-200 rounded-lg transition-colors">
                    Cancelar
                </button>
                <button type="button" onclick="confirmPhaseEvidenceBeneficiariesSelection()" class="px-6 py-2.5 text-sm font-medium text-white bg-[#8a4534] hover:bg-[#a05240] rounded-lg transition-colors">
                    Confirmar Selección
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal de foto -->
<div id="photoModal" class="fixed inset-0 bg-black/80 flex items-center justify-center z-50 hidden">
    <div class="relative max-w-3xl max-h-[85vh]">
        <button onclick="closePhotoModal()" class="absolute -top-4 -right-4 text-white hover:text-gray-300 text-2xl z-10">
            <i class="fas fa-times"></i>
        </button>
        <img id="photoModalImage" src="" alt="Foto de evidencia" class="max-w-full max-h-[80vh] object-contain rounded-lg">
    </div>
</div>

{% endblock %}
