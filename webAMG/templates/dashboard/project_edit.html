{% extends "base_dashboard.html" %}
{% load static %}

{% block active_projects_class %}bg-[#8a4534]/10 text-[#8a4534]{% endblock %}
{% block page_title %}Editar Proyecto{% endblock %}
{% block page_subtitle %}Modifique la información del proyecto{% endblock %}

{% block extra_js %}
<script src="{% static 'src/js/projects.js' %}"></script>
<script src="{% static 'src/js/project_form_validation.js' %}"></script>
<script src="{% static 'src/js/beneficiaries_project.js' %}"></script>
<script src="{% static 'src/js/auto_dismiss.js' %}"></script>
{% endblock %}

{% block dashboard_content %}

<!-- Form -->
<div class="bg-white rounded-xl shadow-sm border border-gray-100">
    <form method="post" action="{% url 'project_edit' project.id %}" class="p-6 space-y-6" enctype="multipart/form-data">
        {% csrf_token %}
        <!-- Información Básica -->
        <div class="border-b border-gray-100 pb-6">
            <h2 class="text-lg font-semibold text-gray-900 mb-4">Información Básica</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Nombre del Proyecto *</label>
                    <input type="text" name="project_name" required value="{{ project.project_name }}" class="w-full px-4 py-2 border border-gray-200 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-[#8a4534]/20 focus:border-[#8a4534]" placeholder="Ejemplo: Escuela Maya">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Código del Proyecto</label>
                    <input type="text" name="project_code" value="{{ project.project_code|default:'' }}" class="w-full px-4 py-2 border border-gray-200 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-[#8a4534]/20 focus:border-[#8a4534]" placeholder="Ejemplo: PRJ-001">
                </div>
            </div>
            <div class="mt-4">
                <label class="block text-sm font-medium text-gray-700 mb-1">Descripción</label>
                <textarea name="description" rows="3" class="w-full px-4 py-2 border border-gray-200 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-[#8a4534]/20 focus:border-[#8a4534]" placeholder="Descripción general del proyecto...">{{ project.description|default:'' }}</textarea>
            </div>
        </div>

        <!-- Ubicación -->
        <div class="border-b border-gray-100 pb-6">
            <h2 class="text-lg font-semibold text-gray-900 mb-4">Ubicación</h2>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <div class="md:col-span-3">
                    <label class="block text-sm font-medium text-gray-700 mb-1">Dirección</label>
                    <input type="text" name="location" value="{{ project.location|default:'' }}" class="w-full px-4 py-2 border border-gray-200 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-[#8a4534]/20 focus:border-[#8a4534]" placeholder="Ejemplo: Sololá, Chimaltenango">
                 </div>
                 <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Municipio</label>
                    <input type="text" name="municipality" value="{{ project.municipality|default:'' }}" onkeypress="return /[a-zA-ZáéíóúÁÉÍÓÚñÑüÜ\s]/.test(event.key)" class="w-full px-4 py-2 border border-gray-200 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-[#8a4534] {% if error_municipality %}border-red-500{% endif %}" placeholder="Ejemplo: Sololá">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Departamento</label>
                    <input type="text" name="department" value="{{ project.department|default:'' }}" onkeypress="return /[a-zA-ZáéíóúÁÉÍÓÚñÑüÜ\s]/.test(event.key)" class="w-full px-4 py-2 border border-gray-200 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-[#8a4534] {% if error_department %}border-red-500{% endif %}" placeholder="Ejemplo: Chimaltenango">
                </div>
            </div>
        </div>

        <!-- Fechas y Estado -->
        <div class="border-b border-gray-100 pb-6">
            <h2 class="text-lg font-semibold text-gray-900 mb-4">Fechas y Estado</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Fecha de Inicio *</label>
                    <input type="date" name="start_date" required value="{{ project.start_date|date:'Y-m-d' }}" class="w-full px-4 py-2 border border-gray-200 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-[#8a4534]/20 focus:border-[#8a4534]">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Fecha de Fin</label>
                    <input type="date" name="end_date" value="{{ project.end_date|date:'Y-m-d'|default:'' }}" class="w-full px-4 py-2 border border-gray-200 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-[#8a4534]/20 focus:border-[#8a4534]">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Estado del Proyecto *</label>
                    <select name="status" required class="w-full px-4 py-2 border border-gray-200 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-[#8a4534]">
                        <option value="">Seleccionar estado...</option>
                        <option value="planificado">Planificado</option>
                        <option value="en_progreso">En Progreso</option>
                        <option value="pausado">Pausado</option>
                        <option value="completado">Completado</option>
                        <option value="cancelado">Cancelado</option>
                    </select>
                </div>
                <div class="flex items-center pt-6">
                    <label class="flex items-center space-x-2">
                        <input type="checkbox" name="has_phases" {% if project.has_phases %}checked{% endif %} class="w-5 h-5 text-gray-700 focus:ring-2 focus:ring-[#8a4534]/20 focus:border-[#8a4534]">
                        <span class="ml-2 text-sm text-gray-600">Tiene fases</span>
                    </label>
                </div>
            </div>
        </div>

         <!-- Imagen de Portada -->
        <div class="border-b border-gray-100 pb-6">
            <h2 class="text-lg font-semibold text-gray-900 mb-4">Imagen de Portada</h2>
            
            <!-- Imagen actual del proyecto -->
            {% if project.cover_image_url %}
            <div class="mb-6">
                <p class="text-sm text-gray-500 mb-2">Imagen actual:</p>
                <div class="relative inline-block">
                    <img src="/media/{{ project.cover_image_url }}" alt="{{ project.project_name }}" class="max-w-xs h-32 object-cover rounded-lg border border-gray-300 shadow-md">
                    <label class="absolute -top-2 -right-2 cursor-pointer">
                        <input type="checkbox" name="remove_cover_image" class="peer sr-only">
                        <div class="w-8 h-8 bg-red-500 hover:bg-red-600 text-white rounded-full flex items-center justify-center shadow-lg transition-colors peer-checked:bg-red-700">
                            <i class="fas fa-times text-xs"></i>
                        </div>
                    </label>
                    <p class="text-xs text-red-600 mt-2">Marque la X roja para eliminar la imagen actual</p>
                </div>
            </div>
            {% endif %}
            
            <!-- Subir nueva imagen -->
            <div class="flex items-start space-x-4">
                <div class="flex-1">
                    <div class="relative">
                        <input type="file" name="cover_image" id="coverImageInput" accept="image/*" class="hidden" onchange="previewImage(this)">
                        <label for="coverImageInput" class="flex items-center justify-center w-full px-4 py-8 border-2 border-dashed border-gray-300 rounded-lg cursor-pointer hover:border-[#8a4534] hover:bg-[#8a4534]/5 transition-all">
                            <div class="flex flex-col items-center space-y-2">
                                <i class="fas fa-cloud-upload-alt text-3xl text-gray-400"></i>
                                <div class="text-center">
                                    <p class="text-sm font-medium text-gray-700">Subir nueva imagen</p>
                                    <p class="text-xs text-gray-500">o arrastra y suelta aquí</p>
                                </div>
                            </div>
                        </label>
                    </div>
                 </div>
                  <div id="imagePreviewContainer" class="hidden flex flex-col items-center justify-center p-6 bg-gray-50 rounded-xl">
                     <div class="relative w-64">
                         <img id="imagePreview" src="" alt="Vista previa" class="w-full h-32 object-cover rounded-lg border border-gray-300 shadow-md">
                         <button type="button" id="removeImageBtn" onclick="removeCoverImage()" class="absolute -top-2 -right-2 w-8 h-8 bg-red-500 hover:bg-red-600 text-white rounded-full shadow-lg transition-colors flex items-center justify-center">
                             <i class="fas fa-times text-xs"></i>
                         </button>
             </div>
         </div>
      </div>
</div>

 

         <!-- Beneficiarios -->
         <div class="border-b border-gray-100 pb-6">
             <div class="flex items-center justify-between mb-4">
                 <h2 class="text-lg font-semibold text-gray-900">Beneficiarios</h2>
                 <button type="button" onclick="openBeneficiaryModal()" class="inline-flex items-center space-x-2 px-4 py-2 text-sm font-medium text-white bg-[#8a4534] hover:bg-[#a05240] rounded-lg transition-colors">
                     <i class="fas fa-plus"></i>
                     <span>Agregar Beneficiario</span>
                 </button>
             </div>
              
             <!-- Lista de Beneficiarios Seleccionados con Scroll -->
            <div id="selectedBeneficiariesList" class="max-h-64 overflow-y-auto border border-gray-200 rounded-lg p-4 space-y-3">
                {% if project_bbeneficiaries %}
                    {% for beneficiary in project_bbeneficiaries %}
                        <div class="beneficiary-selected flex items-center justify-between bg-gray-50 rounded-lg p-3" data-id="{{ beneficiary.id }}">
                            <div class="flex items-center space-x-3">
                                <div class="w-10 h-10 rounded-full bg-gradient-to-br from-[#8a4534] to-[#334e76] flex items-center justify-center text-white text-sm font-semibold">
                                    <span>{{ beneficiary.first_name|slice:':1' }}{{ beneficiary.last_name|slice:':1' }}</span>
                                </div>
                                <div>
                                    <p class="font-medium text-gray-900">{{ beneficiary.first_name }} {{ beneficiary.last_name }}</p>
                                    <p class="text-sm text-gray-500">{% if beneficiary.cui_dpi %}DPI: {{ beneficiary.cui_dpi }}{% else %}Sin DPI{% endif %}</p>
                                </div>
                            </div>
                            <button type="button" onclick="removeBeneficiary('{{ beneficiary.id }}')" class="text-red-500 hover:text-red-700 transition-colors">
                                <i class="fas fa-times text-lg"></i>
                            </button>
                        </div>
                    {% endfor %}
                {% else %}
                    <div class="text-center text-gray-500 py-8">
                        <i class="fas fa-users text-4xl mb-2"></i>
                        <p>No hay beneficiarios asignados</p>
                        <p class="text-sm">Haga clic en "Agregar Beneficiario" para seleccionar beneficiarios del sistema</p>
                    </div>
                {% endif %}
            </div>
        </div>

         <!-- Input hidden para beneficiarios -->
         <input type="hidden" name="beneficiaries" id="beneficiariesInput" value="{% for id in selected_beneficiary_ids %}{{ id }}{% if not forloop.last %},{% endif %}{% endfor %}">
         
         <!-- Mensajes de error específicos -->
         <div id="formErrorMessages"></div>
         
         <!-- Botones -->
        <div class="flex items-center justify-end space-x-3 pt-4">
            <a href="{% url 'project_list' %}" class="px-6 py-2.5 text-sm font-medium text-gray-700 bg-gray-100 hover:bg-gray-200 rounded-lg transition-colors">
                Cancelar
            </a>
            <button type="submit" class="px-6 py-2.5 text-sm font-medium text-white bg-[#8a4534] hover:bg-[#a05240] rounded-lg transition-colors">
                Guardar Cambios
            </button>
        </div>
    </form>
</div>

<!-- Modal de Selección de Beneficiarios -->
<div id="beneficiaryModal" class="fixed inset-0 bg-black/50 flex items-center justify-center z-50 hidden">
    <div class="bg-white rounded-xl shadow-2xl w-full max-w-4xl mx-4 max-h-[90vh] overflow-y-auto">
        <div class="p-6 border-b border-gray-100 sticky top-0 bg-white z-10">
            <div class="flex items-center justify-between">
                <h3 class="text-lg font-semibold text-gray-900">Seleccionar Beneficiarios</h3>
                <button onclick="closeBeneficiaryModal()" class="text-gray-400 hover:text-gray-600 transition-colors">
                    <i class="fas fa-times text-lg"></i>
                </button>
            </div>
            <div class="mt-4">
                <input type="text" id="beneficiarySearch" placeholder="Buscar beneficiario..." class="w-full px-4 py-2 border border-gray-200 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-[#8a4534]/20 focus:border-[#8a4534]" oninput="filterBeneficiaries()">
            </div>
        </div>
        <div class="p-6">
            <div id="beneficiariesList" class="max-h-96 overflow-y-auto space-y-2">
                {% if beneficiaries %}
                    {% for beneficiary in beneficiaries %}
                        <div class="beneficiary-item flex items-center justify-between p-3 bg-gray-50 rounded-lg hover:bg-gray-100 transition-colors cursor-pointer"
                             onclick="toggleBeneficiary(this)"
                             data-id="{{ beneficiary.id }}"
                             data-name="{{ beneficiary.first_name }} {{ beneficiary.last_name }}"
                             data-dpi="{{ beneficiary.cui_dpi|default:'' }}"
                             data-community="{{ beneficiary.community|default:'' }}">
                            <div class="flex items-center space-x-3">
                                <div class="w-10 h-10 rounded-full bg-gradient-to-br from-[#8a4534] to-[#334e76] flex items-center justify-center text-white text-sm font-semibold">
                                    <span>{{ beneficiary.first_name|slice:':1' }}{{ beneficiary.last_name|slice:':1' }}</span>
                                </div>
                                <div>
                                    <p class="font-medium text-gray-900">{{ beneficiary.first_name }} {{ beneficiary.last_name }}</p>
                                    <p class="text-sm text-gray-500">
                                        {% if beneficiary.cui_dpi %}DPI: {{ beneficiary.cui_dpi }}{% else %}Sin DPI{% endif %}
                                        {% if beneficiary.community %} • {{ beneficiary.community }}{% endif %}
                                    </p>
                                </div>
                            </div>
                            <div class="checkbox-indicator w-6 h-6 rounded-full border-2 border-gray-300 flex items-center justify-center {% if beneficiary.id in selected_beneficiary_ids %}bg-[#8a4534] border-[#8a4534]{% else %}bg-gray-300{% endif %}">
                                <i class="fas fa-check text-white text-sm {% if beneficiary.id in selected_beneficiary_ids %}{% else %}hidden{% endif %}"></i>
                            </div>
                        </div>
                    {% endfor %}
                {% else %}
                    <div class="text-center py-8">
                        <i class="fas fa-users text-4xl text-gray-400 mb-2"></i>
                        <p class="text-gray-600">No hay beneficiarios registrados</p>
                        <p class="text-sm text-gray-500">Primero debe registrar beneficiarios en el sistema</p>
                    </div>
                {% endif %}
            </div>
        </div>
        <div class="p-6 border-t border-gray-100 sticky bottom-0 bg-white">
            <div class="flex items-center justify-between">
                <p class="text-sm text-gray-600"><span id="selectedCount">0</span> beneficiarios seleccionados</p>
                <div class="flex items-center space-x-3">
                    <button type="button" onclick="closeBeneficiaryModal()" class="px-4 py-2 text-sm font-medium text-gray-700 bg-gray-100 hover:bg-gray-200 rounded-lg transition-colors">
                        Cancelar
                    </button>
                    <button type="button" onclick="addSelectedBeneficiaries()" class="px-4 py-2 text-sm font-medium text-white bg-[#8a4534] hover:bg-[#a05240] rounded-lg transition-colors">
                        Agregar Seleccionados
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

{% endblock %}