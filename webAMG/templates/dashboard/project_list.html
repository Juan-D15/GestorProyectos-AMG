{% extends "base_dashboard.html" %}
{% load static %}

{% block active_projects_class %}bg-[#8a4534]/10 text-[#8a4534]{% endblock %}
{% block page_title %}Proyectos{% endblock %}
{% block page_subtitle %}Gestión de proyectos de la organización{% endblock %}

{% block extra_js %}
<script src="{% static 'src/js/projects.js' %}"></script>
{% endblock %}

{% block dashboard_content %}
 <!-- Acciones -->
 <div class="flex gap-4 mb-8">
     <a href="{% url 'project_create' %}" class="flex-1 bg-white rounded-xl p-6 shadow-sm border border-gray-100 card-hover cursor-pointer inline-flex items-center space-x-4">
         <div class="w-12 h-12 rounded-lg bg-[#8a4534]/10 flex items-center justify-center">
             <i class="fas fa-plus text-xl text-[#8a4534]"></i>
         </div>
         <div>
             <h3 class="text-lg font-semibold text-gray-900">Crear Proyecto</h3>
             <p class="text-sm text-gray-500">Agregar un nuevo proyecto al sistema</p>
         </div>
     </a>
      <button onclick="toggleInactiveProjects()" id="toggleInactiveBtn" class="flex-1 bg-white rounded-xl p-6 shadow-sm border border-gray-100 card-hover cursor-pointer inline-flex items-center space-x-4 transition-colors">
         <div class="w-12 h-12 rounded-lg bg-gray-500/10 flex items-center justify-center">
             <i class="fas fa-archive text-xl text-gray-500"></i>
         </div>
         <div>
             <h3 class="text-lg font-semibold text-gray-900">Ver Inactivos</h3>
             <p class="text-sm text-gray-500">Proyectos desactivados</p>
         </div>
     </button>
 </div>

 <!-- Filtros y Búsqueda -->
 <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-4 mb-6">
     <form method="get">
         <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-5 gap-3 mb-3">
             <!-- Búsqueda -->
             <div class="lg:col-span-1">
                 <label class="block text-xs font-medium text-gray-700 mb-1">Buscar</label>
                 <div class="relative">
                     <i class="fas fa-search absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400 text-sm"></i>
                     <input 
                         type="text" 
                         name="search" 
                         value="{{ search_query }}"
                         placeholder="Nombre, código..." 
                         class="w-full pl-9 pr-3 py-2 border border-gray-200 rounded-md text-sm focus:outline-none focus:ring-2 focus:ring-[#8a4534]/20 focus:border-[#8a4534]"
                     >
                 </div>
             </div>
             
             <!-- Estado -->
             <div>
                 <label class="block text-xs font-medium text-gray-700 mb-1">Estado</label>
                 <select 
                     name="status" 
                     class="w-full px-3 py-2 border border-gray-200 rounded-md text-sm focus:outline-none focus:ring-2 focus:ring-[#8a4534]/20 focus:border-[#8a4534]"
                 >
                     <option value="">Todos</option>
                     <option value="planificado" {% if status_filter == 'planificado' %}selected{% endif %}>Planificado</option>
                     <option value="en_progreso" {% if status_filter == 'en_progreso' %}selected{% endif %}>En Progreso</option>
                     <option value="pausado" {% if status_filter == 'pausado' %}selected{% endif %}>Pausado</option>
                     <option value="completado" {% if status_filter == 'completado' %}selected{% endif %}>Completado</option>
                     <option value="cancelado" {% if status_filter == 'cancelado' %}selected{% endif %}>Cancelado</option>
                 </select>
             </div>

             <!-- Fecha Inicio -->
             <div>
                 <label class="block text-xs font-medium text-gray-700 mb-1">Fecha Inicio</label>
                 <input 
                     type="date" 
                     name="filter_start_date" 
                     value="{{ filter_start_date }}"
                     class="w-full px-3 py-2 border border-gray-200 rounded-md text-sm focus:outline-none focus:ring-2 focus:ring-[#8a4534]/20 focus:border-[#8a4534]"
                 >
             </div>

             <!-- Fecha Fin -->
             <div>
                 <label class="block text-xs font-medium text-gray-700 mb-1">Fecha Fin</label>
                 <input 
                     type="date" 
                     name="filter_end_date" 
                     value="{{ filter_end_date }}"
                     class="w-full px-3 py-2 border border-gray-200 rounded-md text-sm focus:outline-none focus:ring-2 focus:ring-[#8a4534]/20 focus:border-[#8a4534]"
                 >
             </div>

             <!-- Año -->
             <div>
                 <label class="block text-xs font-medium text-gray-700 mb-1">Año</label>
                 <input 
                     type="text" 
                     name="filter_year" 
                     value="{{ filter_year }}"
                     placeholder="2024"
                     class="w-full px-3 py-2 border border-gray-200 rounded-md text-sm focus:outline-none focus:ring-2 focus:ring-[#8a4534]/20 focus:border-[#8a4534]"
                     onkeypress="return event.charCode >= 48 && event.charCode <= 57"
                     oninput="this.value = this.value.replace(/[^0-9]/g, ''); if (this.value && this.value > 2100) this.value = 2100;"
                 >
             </div>

             <!-- Departamento -->
             <div>
                 <label class="block text-xs font-medium text-gray-700 mb-1">Departamento</label>
                 <input 
                     type="text" 
                     name="filter_department" 
                     id="filterDepartmentInput"
                     value="{{ filter_department }}"
                     placeholder="Escribe..."
                     autocomplete="off"
                     class="w-full px-3 py-2 border border-gray-200 rounded-md text-sm focus:outline-none focus:ring-2 focus:ring-[#8a4534]/20 focus:border-[#8a4534]"
                     onkeypress="return event.keyCode !== 8 && !/[0-9]/.test(event.key)"
                     oninput="this.value = this.value.replace(/[0-9]/g, '');"
                 >
             </div>

             <!-- Municipio -->
             <div>
                 <label class="block text-xs font-medium text-gray-700 mb-1">Municipio</label>
                 <input 
                     type="text" 
                     name="filter_municipality" 
                     id="filterMunicipalityInput"
                     value="{{ filter_municipality }}"
                     placeholder="Escribe..."
                     autocomplete="off"
                     class="w-full px-3 py-2 border border-gray-200 rounded-md text-sm focus:outline-none focus:ring-2 focus:ring-[#8a4534]/20 focus:border-[#8a4534]"
                     onkeypress="return event.keyCode !== 8 && !/[0-9]/.test(event.key)"
                     oninput="this.value = this.value.replace(/[0-9]/g, '');"
                 >
             </div>

             <!-- Botones de acción -->
             <div class="flex items-end space-x-2">
                 <button type="submit" class="flex-1 px-4 py-2 text-sm font-medium text-white bg-[#8a4534] hover:bg-[#a05240] rounded-md transition-colors">
                     <i class="fas fa-filter mr-2"></i>Filtrar
                 </button>
                 <a href="{% url 'project_list' %}" class="px-3 py-2 text-sm font-medium text-gray-700 bg-gray-100 hover:bg-gray-200 rounded-md transition-colors">
                     <i class="fas fa-times"></i>
                 </a>
             </div>
         </div>
     </form>
 </div>

 <!-- Lista de Proyectos -->
 <div class="bg-white rounded-xl shadow-sm border border-gray-100" id="activeProjectsSection">
     {% if projects %}
        <div class="overflow-x-auto">
            <table class="w-full">
                <thead>
                    <tr class="border-b border-gray-100">
                        <th class="text-left py-4 px-6 text-sm font-semibold text-gray-700">Proyecto</th>
                        <th class="text-left py-4 px-6 text-sm font-semibold text-gray-700">Ubicación</th>
                        <th class="text-left py-4 px-6 text-sm font-semibold text-gray-700">Estado</th>
                        <th class="text-left py-4 px-6 text-sm font-semibold text-gray-700">Fecha Inicio</th>
                        <th class="text-right py-4 px-6 text-sm font-semibold text-gray-700">Acciones</th>
                    </tr>
                </thead>
                <tbody>
                    {% for project in projects %}
                        <tr class="border-b border-gray-50 hover:bg-gray-50" data-project-id="{{ project.id }}">
                            <td class="py-4 px-6">
                                <div class="flex items-center space-x-3">
                                    {% if project.cover_image_url %}
                                        <img src="/media/{{ project.cover_image_url }}" alt="{{ project.project_name }}" class="w-12 h-12 rounded-lg object-cover">
                                    {% else %}
                                        <div class="w-12 h-12 rounded-lg bg-[#8a4534]/10 flex items-center justify-center">
                                            <i class="fas fa-project-diagram text-[#8a4534]"></i>
                                        </div>
                                    {% endif %}
                                    <div>
                                        <p class="font-medium text-gray-900">{{ project.project_name }}</p>
                                        {% if project.project_code %}
                                            <p class="text-sm text-gray-500">{{ project.project_code }}</p>
                                        {% endif %}
                                    </div>
                                </div>
                            </td>
                            <td class="py-4 px-6">
                                <div class="text-sm text-gray-700">
                                    <p>
                                        {% if project.municipality %}
                                            {{ project.municipality }}
                                        {% else %}
                                            <span class="text-gray-400">No especificado</span>
                                        {% endif %}
                                    </p>
                                    <p class="text-xs text-gray-500">
                                        {% if project.department %}
                                            {{ project.department }}
                                        {% endif %}
                                    </p>
                                </div>
                            </td>
                            <td class="py-4 px-6">
                                {% if project.status == 'planificado' %}
                                    <span class="px-3 py-1 rounded-full text-xs font-medium bg-blue-100 text-blue-700">Planificado</span>
                                {% elif project.status == 'en_progreso' %}
                                    <span class="px-3 py-1 rounded-full text-xs font-medium bg-yellow-100 text-yellow-700">En Progreso</span>
                                {% elif project.status == 'pausado' %}
                                    <span class="px-3 py-1 rounded-full text-xs font-medium bg-orange-100 text-orange-700">Pausado</span>
                                {% elif project.status == 'completado' %}
                                    <span class="px-3 py-1 rounded-full text-xs font-medium bg-green-100 text-green-700">Completado</span>
                                {% elif project.status == 'cancelado' %}
                                    <span class="px-3 py-1 rounded-full text-xs font-medium bg-red-100 text-red-700">Cancelado</span>
                                {% endif %}
                            </td>
                            <td class="py-4 px-6">
                                <p class="text-sm text-gray-700">{{ project.start_date|date:"d/m/Y" }}</p>
                            </td>
                            <td class="py-4 px-6">
                                <div class="flex items-center justify-end space-x-2">
                                    <button type="button" class="p-2 text-gray-400 hover:text-[#8a4534] hover:bg-[#8a4534]/10 rounded-lg transition-colors" onclick="editProject({{ project.id }})" data-edit-id="{{ project.id }}">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                    <button type="button" class="p-2 text-red-400 hover:text-red-600 hover:bg-red-50 rounded-lg transition-colors" onclick="deleteProject({{ project.id }})" data-delete-id="{{ project.id }}">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            </td>
                        </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
     {% else %}
        <div class="py-12 text-center">
            <i class="fas fa-folder-open text-6xl text-gray-300 mb-4"></i>
            <h3 class="text-lg font-semibold text-gray-900 mb-2">No hay proyectos</h3>
            <p class="text-gray-500 mb-6">
                {% if search_query or status_filter or filter_start_date or filter_end_date or filter_department or filter_municipality or filter_year %}
                    No se encontraron proyectos con los filtros actuales.
                {% else %}
                    No hay proyectos registrados en el sistema.
                 {% endif %}
             </p>
             <a href="{% url 'project_create' %}" class="inline-flex items-center space-x-2 px-6 py-3 bg-[#8a4534] hover:bg-[#a05240] text-white font-medium rounded-lg transition-colors">
                  <i class="fas fa-plus"></i>
                  <span>Crear Proyecto</span>
             </a>
        </div>
     {% endif %}
 </div>

 <!-- Lista de Proyectos Inactivos (oculto por defecto) -->
 <div class="bg-white rounded-xl shadow-sm border border-gray-200 hidden mb-6" id="inactiveProjectsSection">
     <div class="p-4 bg-gray-50 border-b border-gray-200 flex items-center justify-between">
         <div class="flex items-center space-x-2">
             <i class="fas fa-archive text-gray-500"></i>
             <h3 class="text-lg font-semibold text-gray-900">Proyectos Desactivados</h3>
         </div>
         <button onclick="toggleInactiveProjects()" class="px-3 py-1 text-sm font-medium text-gray-600 bg-white border border-gray-300 rounded hover:bg-gray-50 transition-colors">
             <i class="fas fa-times mr-1"></i>Cerrar
         </button>
     </div>
     <div class="overflow-x-auto">
         <table class="w-full">
             <thead>
                 <tr class="border-b border-gray-200">
                     <th class="text-left py-3 px-4 text-sm font-semibold text-gray-700">Proyecto</th>
                     <th class="text-left py-3 px-4 text-sm font-semibold text-gray-700">Ubicación</th>
                     <th class="text-left py-3 px-4 text-sm font-semibold text-gray-700">Estado</th>
                     <th class="text-left py-3 px-4 text-sm font-semibold text-gray-700">Fecha Desactivación</th>
                     <th class="text-right py-3 px-4 text-sm font-semibold text-gray-700">Acciones</th>
                 </tr>
             </thead>
             <tbody id="inactiveProjectsTableBody">
             </tbody>
         </table>
     </div>
 </div>
 {% endblock %}
