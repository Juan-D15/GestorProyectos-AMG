{% extends "base_dashboard.html" %}
{% load static %}

{% block active_projects_class %}bg-[#8a4534]/10 text-[#8a4534]{% endblock %}
{% block page_title %}Crear Proyecto{% endblock %}
{% block page_subtitle %}Complete el formulario para crear un nuevo proyecto{% endblock %}

{% block extra_js %}
<script src="{% static 'src/js/projects.js' %}"></script>
<script src="{% static 'src/js/beneficiaries.js' %}"></script>
{% endblock %}

{% block dashboard_content %}

<!-- Form -->
<div class="bg-white rounded-xl shadow-sm border border-gray-100">
    <form method="post" action="{% url 'project_create' %}" class="p-6 space-y-6" enctype="multipart/form-data">
        {% csrf_token %}
        <!-- Información Básica -->
        <div class="border-b border-gray-100 pb-6">
            <h2 class="text-lg font-semibold text-gray-900 mb-4">Información Básica</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Nombre del Proyecto *</label>
                    <input type="text" name="project_name" required class="w-full px-4 py-2 border border-gray-200 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-[#8a4534]/20 focus:border-[#8a4534]" placeholder="Ejemplo: Escuela Maya">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Código del Proyecto</label>
                    <input type="text" name="project_code" value="{{ error_project_code|default:'' }}" class="w-full px-4 py-2 border border-gray-200 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-[#8a4534]/20 focus:border-[#8a4534] {% if error_project_code %}border-red-500{% endif %}" placeholder="Ejemplo: PRJ-001">
                </div>
            </div>
            <div class="mt-4">
                <label class="block text-sm font-medium text-gray-700 mb-1">Descripción</label>
                <textarea name="description" rows="3" class="w-full px-4 py-2 border border-gray-200 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-[#8a4534]/20 focus:border-[#8a4534]" placeholder="Descripción general del proyecto..."></textarea>
            </div>
        </div>

        <!-- Ubicación -->
        <div class="border-b border-gray-100 pb-6">
            <h2 class="text-lg font-semibold text-gray-900 mb-4">Ubicación</h2>
             <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Departamento</label>
                    <input type="text" name="department" value="{{ error_department|default:'' }}"  onkeypress="return /[a-zA-ZáéíóúÁÉÍÓÚñÑüÜ\s]/.test(event.key)" class="w-full px-4 py-2 border border-gray-200 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-[#8a4534]/20 focus:border-[#8a4534] {% if error_department %}border-red-500{% endif %}" placeholder="Ejemplo: Alta Verapaz">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Municipio</label>
                    <input type="text" name="municipality" value="{{ error_municipality|default:'' }}"  onkeypress="return /[a-zA-ZáéíóúÁÉÍÓÚñÑüÜ\s]/.test(event.key)" class="w-full px-4 py-2 border border-gray-200 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-[#8a4534]/20 focus:border-[#8a4534] {% if error_municipality %}border-red-500{% endif %}" placeholder="Ejemplo: Cobán">
                </div>
                <div class="md:col-span-3">
                    <label class="block text-sm font-medium text-gray-700 mb-1">Dirección</label>
                    <input type="text" name="location" class="w-full px-4 py-2 border border-gray-200 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-[#8a4534]/20 focus:border-[#8a4534]" placeholder="Ejemplo: Calle Principal #123, Ciudad">
                </div>
            </div>
        </div>

        <!-- Fechas y Estado -->
        <div class="border-b border-gray-100 pb-6">
            <h2 class="text-lg font-semibold text-gray-900 mb-4">Fechas y Estado</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Fecha de Inicio *</label>
                    <input type="date" name="start_date" required class="w-full px-4 py-2 border border-gray-200 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-[#8a4534]/20 focus:border-[#8a4534]">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Fecha de Fin</label>
                    <input type="date" name="end_date" class="w-full px-4 py-2 border border-gray-200 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-[#8a4534]/20 focus:border-[#8a4534]">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Estado del Proyecto *</label>
                    <select name="status" required class="w-full px-4 py-2 border border-gray-200 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-[#8a4534]/20 focus:border-[#8a4534]">
                        <option value="">Seleccionar estado...</option>
                        <option value="planificado">Planificado</option>
                        <option value="en_progreso">En Progreso</option>
                        <option value="pausado">Pausado</option>
                        <option value="completado">Completado</option>
                        <option value="cancelado">Cancelado</option>
                    </select>
                </div>
                <div class="flex items-center pt-6">
                    <label class="flex items-center space-x-2">
                        <input type="checkbox" name="has_phases" id="hasPhases" class="w-5 h-5 text-gray-700 focus:ring-2 focus:ring-[#8a4534]/20 focus:border-[#8a4534]" onclick="togglePhases()">
                        <span class="ml-2 text-sm text-gray-600">Tiene fases</span>
                    </label>
                </div>
            </div>
        </div>

        <!-- Imagen de Portada -->
        <div class="border-b border-gray-100 pb-6">
            <h2 class="text-lg font-semibold text-gray-900 mb-4">Imagen de Portada</h2>
            <div class="flex items-start space-x-4">
                <div class="flex-1">
                    <div class="relative">
                        <input type="file" name="cover_image" id="coverImageInput" accept="image/*" class="hidden" onchange="previewImage(this)">
                        <label for="coverImageInput" class="flex items-center justify-center w-full px-4 py-8 border-2 border-dashed border-gray-300 rounded-lg cursor-pointer hover:border-[#8a4534] hover:bg-[#8a4534]/5 transition-all">
                            <div class="flex flex-col items-center space-y-2">
                                <i class="fas fa-cloud-upload-alt text-3xl text-gray-400"></i>
                                <div class="text-center">
                                    <p class="text-sm font-medium text-gray-700">Subir nueva imagen</p>
                                    <p class="text-xs text-gray-500">o arrastra y suelta aquí</p>
                                </div>
                            </div>
                        </label>
                    </div>
                 </div>
                  <div id="imagePreviewContainer" class="hidden flex flex-col items-center justify-center p-6 bg-gray-50 rounded-xl">
                     <div class="relative w-64">
                         <img id="imagePreview" src="" alt="Vista previa" class="w-full h-32 object-cover rounded-lg border border-gray-300 shadow-md">
                         <button type="button" id="removeImageBtn" onclick="removeCoverImage()" class="absolute -top-2 -right-2 w-8 h-8 bg-red-500 hover:bg-red-600 text-white rounded-full shadow-lg transition-colors flex items-center justify-center">
                             <i class="fas fa-times text-xs"></i>
                         </button>
                     </div>
                 </div>
            </div>
        </div>

        <!-- Beneficiarios -->
        <div class="border-b border-gray-100 pb-6">
            <div class="flex items-center justify-between mb-4">
                <h2 class="text-lg font-semibold text-gray-900">Beneficiarios</h2>
                <button type="button" onclick="openBeneficiaryModal()" class="inline-flex items-center space-x-2 px-4 py-2 text-sm font-medium text-white bg-[#8a4534] hover:bg-[#a05240] rounded-lg transition-colors">
                    <i class="fas fa-plus"></i>
                    <span>Agregar Beneficiario</span>
                </button>
            </div>
             
            <!-- Lista de Beneficiarios Seleccionados con Scroll -->
            <div id="selectedBeneficiariesList" class="max-h-64 overflow-y-auto border border-gray-200 rounded-lg p-4 space-y-3">
                <div class="text-center text-gray-500 py-8">
                    <i class="fas fa-users text-4xl mb-2"></i>
                    <p>No hay beneficiarios seleccionados</p>
                    <p class="text-sm">Haga clic en "Agregar Beneficiario" para seleccionar beneficiarios del sistema</p>
                </div>
            </div>
        </div>

        <!-- Input hidden para beneficiarios -->
        <input type="hidden" name="beneficiaries" id="beneficiariesInput">
        
        <!-- Mensajes de error específicos -->
        <div id="formErrorMessages"></div>
        
        <!-- Botones -->
        <div class="flex items-center justify-end space-x-3 pt-4">
            <a href="{% url 'dashboard_projects' %}" class="px-6 py-2.5 text-sm font-medium text-gray-700 bg-gray-100 hover:bg-gray-200 rounded-lg transition-colors">
                Cancelar
            </a>
            <button type="submit" class="px-6 py-2.5 text-sm font-medium text-white bg-[#8a4534] hover:bg-[#a05240] rounded-lg transition-colors">
                Crear Proyecto
            </button>
        </div>
    </form>
</div>

<!-- Modal de Selección de Beneficiarios -->
<div id="beneficiaryModal" class="fixed inset-0 bg-black/50 flex items-center justify-center z-50 hidden">
    <div class="bg-white rounded-xl shadow-2xl w-full max-w-4xl mx-4 max-h-[90vh] overflow-y-auto">
        <div class="p-6 border-b border-gray-100 sticky top-0 bg-white z-10">
            <div class="flex items-center justify-between">
                <h3 class="text-lg font-semibold text-gray-900">Seleccionar Beneficiarios</h3>
                <button onclick="closeBeneficiaryModal()" class="text-gray-400 hover:text-gray-600 transition-colors">
                    <i class="fas fa-times text-lg"></i>
                </button>
            </div>
            <div class="mt-4">
                <input type="text" id="beneficiarySearch" placeholder="Buscar beneficiario..." class="w-full px-4 py-2 border border-gray-200 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-[#8a4534]/20 focus:border-[#8a4534]" oninput="filterBeneficiaries()">
            </div>
        </div>
        <div class="p-6">
            <div id="beneficiariesList" class="max-h-96 overflow-y-auto space-y-2">
                {% if beneficiaries %}
                    {% for beneficiary in beneficiaries %}
                    <div class="beneficiary-item flex items-center justify-between p-3 bg-gray-50 rounded-lg hover:bg-gray-100 transition-colors cursor-pointer"
                         onclick="toggleBeneficiary(this)"
                         data-id="{{ beneficiary.id }}"
                         data-name="{{ beneficiary.first_name }} {{ beneficiary.last_name }}"
                         data-dpi="{{ beneficiary.cui_dpi|default:'' }}"
                         data-community="{{ beneficiary.community|default:'' }}">
                        <div class="flex items-center space-x-3">
                            <div class="w-10 h-10 rounded-full bg-gradient-to-br from-[#8a4534] to-[#334e76] flex items-center justify-center text-white text-sm font-semibold">
                                <span>{{ beneficiary.first_name|slice:":1" }}{{ beneficiary.last_name|slice:":1" }}</span>
                            </div>
                            <div>
                                <p class="font-medium text-gray-900">{{ beneficiary.first_name }} {{ beneficiary.last_name }}</p>
                                <p class="text-sm text-gray-500">
                                    {% if beneficiary.cui_dpi %}DPI: {{ beneficiary.cui_dpi }}{% else %}Sin DPI{% endif %}
                                    {% if beneficiary.community %} • {{ beneficiary.community }}{% endif %}
                                </p>
                            </div>
                        </div>
                        <div class="checkbox-indicator w-6 h-6 rounded-full border-2 border-gray-300 flex items-center justify-center">
                            <i class="fas fa-check text-white text-sm hidden"></i>
                        </div>
                    </div>
                    {% endfor %}
                {% else %}
                    <div class="text-center text-gray-500 py-8">
                        <i class="fas fa-users text-4xl mb-2"></i>
                        <p>No hay beneficiarios registrados</p>
                        <p class="text-sm">Primero debe registrar beneficiarios en el sistema</p>
                    </div>
                {% endif %}
            </div>
        </div>
        <div class="p-6 border-t border-gray-100 sticky bottom-0 bg-white">
            <div class="flex items-center justify-between">
                <p class="text-sm text-gray-600"><span id="selectedCount">0</span> beneficiarios seleccionados</p>
                <div class="flex items-center space-x-3">
                    <button type="button" onclick="closeBeneficiaryModal()" class="px-4 py-2 text-sm font-medium text-gray-700 bg-gray-100 hover:bg-gray-200 rounded-lg transition-colors">
                        Cancelar
                    </button>
                    <button type="button" onclick="addSelectedBeneficiaries()" class="px-4 py-2 text-sm font-medium text-white bg-[#8a4534] hover:bg-[#a05240] rounded-lg transition-colors">
                        Agregar Seleccionados
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// Función para validar y mostrar errores específicos del formulario
document.addEventListener('DOMContentLoaded', function() {
    const form = document.querySelector('form');
    const errorMessagesDiv = document.getElementById('formErrorMessages');
    
    if (form && errorMessagesDiv) {
        form.addEventListener('submit', function(e) {
            // Limpiar errores anteriores
            errorMessagesDiv.innerHTML = '';
            
            const project_name = form.querySelector('input[name="project_name"]').value.trim();
            const project_code = form.querySelector('input[name="project_code"]').value.trim();
            
            let errors = [];
            
            // Validar nombre del proyecto
            if (!project_name) {
                errors.push('El nombre del proyecto es obligatorio');
            }
            
            // Validar código del proyecto si se ingresó
            if (project_code && !/^[a-zA-Z0-9-]+$/.test(project_code)) {
                errors.push('El código solo puede contener letras, números y guiones');
            }
            
            // Mostrar errores si los hay
            if (errors.length > 0) {
                e.preventDefault();
                
                errorMessagesDiv.innerHTML = `
                    <div class="mb-6 p-4 rounded-lg bg-red-100 border-red-200 text-red-700" data-auto-dismiss="5000">
                        <div class="mb-3">
                            <div class="flex items-center">
                                <i class="fas fa-exclamation-circle mr-2"></i>
                                <p class="font-medium">Por favor corrija los siguientes errores:</p>
                            </div>
                        </div>
                        <ul class="list-disc list-inside space-y-1 text-sm">
                            ${errors.map(error => `<li>${error}</li>`).join('')}
                        </ul>
                    </div>
                `;
                
                // Scroll al inicio del formulario
                form.scrollIntoView({ behavior: 'smooth' });
                
                // Disparar evento personalizado para el script de auto-dismiss
                const customEvent = new CustomEvent('messagesUpdated', { detail: { messages: document.querySelectorAll('[data-auto-dismiss]') } });
                document.dispatchEvent(customEvent);
            }
        });
    }
});
</script>

{% endblock %}
