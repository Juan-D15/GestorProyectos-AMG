{% extends "base_dashboard.html" %}
{% load static %}

{% block active_projects_class %}bg-[#8a4534]/10 text-[#8a4534]{% endblock %}
{% block page_title %}Crear Proyecto{% endblock %}
{% block page_subtitle %}Complete el formulario para crear un nuevo proyecto{% endblock %}

{% block dashboard_content %}
<!-- Form -->
<div class="bg-white rounded-xl shadow-sm border border-gray-100">
    <form class="p-6 space-y-6" enctype="multipart/form-data">
        <!-- Información Básica -->
        <div class="border-b border-gray-100 pb-6">
            <h2 class="text-lg font-semibold text-gray-900 mb-4">Información Básica</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Nombre del Proyecto *</label>
                    <input type="text" name="project_name" required class="w-full px-4 py-2 border border-gray-200 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-[#8a4534]/20 focus:border-[#8a4534]" placeholder="Ejemplo: Escuela Maya">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Código del Proyecto</label>
                    <input type="text" name="project_code" class="w-full px-4 py-2 border border-gray-200 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-[#8a4534]/20 focus:border-[#8a4534]" placeholder="Ejemplo: PRJ-001">
                </div>
            </div>
            <div class="mt-4">
                <label class="block text-sm font-medium text-gray-700 mb-1">Descripción</label>
                <textarea name="description" rows="3" class="w-full px-4 py-2 border border-gray-200 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-[#8a4534]/20 focus:border-[#8a4534]" placeholder="Descripción general del proyecto..."></textarea>
            </div>
        </div>

        <!-- Fechas y Estado -->
        <div class="border-b border-gray-100 pb-6">
            <h2 class="text-lg font-semibold text-gray-900 mb-4">Fechas y Estado</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Fecha de Inicio *</label>
                    <input type="date" name="start_date" required class="w-full px-4 py-2 border border-gray-200 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-[#8a4534]/20 focus:border-[#8a4534]">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Fecha de Fin</label>
                    <input type="date" name="end_date" class="w-full px-4 py-2 border border-gray-200 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-[#8a4534]/20 focus:border-[#8a4534]">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Estado del Proyecto *</label>
                    <select name="status" required class="w-full px-4 py-2 border border-gray-200 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-[#8a4534]/20 focus:border-[#8a4534]">
                        <option value="">Seleccionar estado...</option>
                        <option value="planificado">Planificado</option>
                        <option value="en_progreso">En Progreso</option>
                        <option value="pausado">Pausado</option>
                        <option value="completado">Completado</option>
                        <option value="cancelado">Cancelado</option>
                    </select>
                </div>
                <div class="flex items-center pt-6">
                    <label class="flex items-center space-x-2">
                        <input type="checkbox" name="has_phases" id="hasPhases" class="w-5 h-5 text-[#8a4534] rounded focus:ring-2 focus:ring-[#8a4534]/20 focus:border-[#8a4534]">
                        <span class="text-sm font-medium text-gray-700">Este proyecto tiene fases</span>
                    </label>
                </div>
            </div>
        </div>

        <!-- Imagen de Portada -->
        <div class="border-b border-gray-100 pb-6">
            <h2 class="text-lg font-semibold text-gray-900 mb-4">Imagen de Portada</h2>
            <div class="flex items-start space-x-4">
                <div class="flex-1">
                    <input type="file" name="cover_image" id="coverImageInput" accept="image/*" class="w-full px-4 py-2 border border-gray-200 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-[#8a4534]/20 focus:border-[#8a4534]" onchange="previewImage(this)">
                </div>
                <div id="imagePreviewContainer" class="hidden flex flex-col items-center">
                    <img id="imagePreview" src="" alt="Vista previa" class="w-32 h-32 object-cover rounded-lg border border-gray-300">
                    <button type="button" id="removeImageBtn" onclick="removeCoverImage()" class="mt-2 px-3 py-1 bg-red-100 hover:bg-red-200 text-red-600 text-sm rounded-lg transition-colors">
                        <i class="fas fa-times mr-1"></i> Eliminar
                    </button>
                </div>
            </div>
        </div>

        <!-- Ubicación -->
        <div class="border-b border-gray-100 pb-6">
            <h2 class="text-lg font-semibold text-gray-900 mb-4">Ubicación</h2>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <div class="md:col-span-3">
                    <label class="block text-sm font-medium text-gray-700 mb-1">Ubicación</label>
                    <input type="text" name="location" class="w-full px-4 py-2 border border-gray-200 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-[#8a4534]/20 focus:border-[#8a4534]" placeholder="Ejemplo: Sololá, Chimaltenango">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Municipio</label>
                    <input type="text" name="municipality" class="w-full px-4 py-2 border border-gray-200 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-[#8a4534]/20 focus:border-[#8a4534]" placeholder="Ejemplo: Sololá">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Departamento</label>
                    <input type="text" name="department" class="w-full px-4 py-2 border border-gray-200 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-[#8a4534]/20 focus:border-[#8a4534]" placeholder="Ejemplo: Chimaltenango">
                </div>
            </div>
        </div>

        <!-- Beneficiarios -->
        <div class="border-b border-gray-100 pb-6">
            <div class="flex items-center justify-between mb-4">
                <h2 class="text-lg font-semibold text-gray-900">Beneficiarios</h2>
                <button type="button" onclick="openBeneficiaryModal()" class="inline-flex items-center space-x-2 px-4 py-2 text-sm font-medium text-white bg-[#8a4534] hover:bg-[#a05240] rounded-lg transition-colors">
                    <i class="fas fa-plus"></i>
                    <span>Agregar Beneficiario</span>
                </button>
            </div>
            
            <!-- Lista de Beneficiarios Seleccionados con Scroll -->
            <div id="selectedBeneficiariesList" class="max-h-64 overflow-y-auto border border-gray-200 rounded-lg p-4 space-y-3">
                <div class="text-center text-gray-500 py-8">
                    <i class="fas fa-users text-4xl mb-2"></i>
                    <p>No hay beneficiarios seleccionados</p>
                    <p class="text-sm">Haga clic en "Agregar Beneficiario" para seleccionar beneficiarios del sistema</p>
                </div>
            </div>
        </div>

        <!-- Botones -->
        <div class="flex items-center justify-end space-x-3 pt-4">
            <a href="{% url 'dashboard_projects' %}" class="px-6 py-2.5 text-sm font-medium text-gray-700 bg-gray-100 hover:bg-gray-200 rounded-lg transition-colors">
                Cancelar
            </a>
            <button type="submit" class="px-6 py-2.5 text-sm font-medium text-white bg-[#8a4534] hover:bg-[#a05240] rounded-lg transition-colors">
                Crear Proyecto
            </button>
        </div>
    </form>
</div>

<!-- Modal de Selección de Beneficiarios -->
<div id="beneficiaryModal" class="fixed inset-0 bg-black/50 flex items-center justify-center z-50 hidden">
    <div class="bg-white rounded-xl shadow-2xl w-full max-w-4xl mx-4 max-h-[90vh] overflow-y-auto">
        <div class="p-6 border-b border-gray-100 sticky top-0 bg-white z-10">
            <div class="flex items-center justify-between">
                <h3 class="text-lg font-semibold text-gray-900">Seleccionar Beneficiarios</h3>
                <button onclick="closeBeneficiaryModal()" class="text-gray-400 hover:text-gray-600 transition-colors">
                    <i class="fas fa-times text-lg"></i>
                </button>
            </div>
            <div class="mt-4">
                <input type="text" id="beneficiarySearch" placeholder="Buscar beneficiario..." class="w-full px-4 py-2 border border-gray-200 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-[#8a4534]/20 focus:border-[#8a4534]" oninput="filterBeneficiaries()">
            </div>
        </div>
        <div class="p-6">
            <div id="beneficiariesList" class="max-h-96 overflow-y-auto space-y-2">
                <!-- Lista de beneficiarios del sistema -->
                <div class="beneficiary-item flex items-center justify-between p-3 bg-gray-50 rounded-lg hover:bg-gray-100 transition-colors cursor-pointer" onclick="toggleBeneficiary(this)">
                    <div class="flex items-center space-x-3">
                        <div class="w-10 h-10 rounded-full bg-gradient-to-br from-[#8a4534] to-[#334e76] flex items-center justify-center text-white text-sm font-semibold">
                            <span>JP</span>
                        </div>
                        <div>
                            <p class="font-medium text-gray-900">Juan Pérez</p>
                            <p class="text-sm text-gray-500">DPI: 1234567890101</p>
                        </div>
                    </div>
                    <div class="checkbox-indicator w-6 h-6 rounded-full border-2 border-gray-300 flex items-center justify-center">
                        <i class="fas fa-check text-white text-sm hidden"></i>
                    </div>
                </div>
                <div class="beneficiary-item flex items-center justify-between p-3 bg-gray-50 rounded-lg hover:bg-gray-100 transition-colors cursor-pointer" onclick="toggleBeneficiary(this)">
                    <div class="flex items-center space-x-3">
                        <div class="w-10 h-10 rounded-full bg-gradient-to-br from-[#8a4534] to-[#334e76] flex items-center justify-center text-white text-sm font-semibold">
                            <span>MG</span>
                        </div>
                        <div>
                            <p class="font-medium text-gray-900">María García</p>
                            <p class="text-sm text-gray-500">DPI: 9876543210101</p>
                        </div>
                    </div>
                    <div class="checkbox-indicator w-6 h-6 rounded-full border-2 border-gray-300 flex items-center justify-center">
                        <i class="fas fa-check text-white text-sm hidden"></i>
                    </div>
                </div>
                <div class="beneficiary-item flex items-center justify-between p-3 bg-gray-50 rounded-lg hover:bg-gray-100 transition-colors cursor-pointer" onclick="toggleBeneficiary(this)">
                    <div class="flex items-center space-x-3">
                        <div class="w-10 h-10 rounded-full bg-gradient-to-br from-[#8a4534] to-[#334e76] flex items-center justify-center text-white text-sm font-semibold">
                            <span>CR</span>
                        </div>
                        <div>
                            <p class="font-medium text-gray-900">Carlos Rodríguez</p>
                            <p class="text-sm text-gray-500">DPI: 4567891230101</p>
                        </div>
                    </div>
                    <div class="checkbox-indicator w-6 h-6 rounded-full border-2 border-gray-300 flex items-center justify-center">
                        <i class="fas fa-check text-white text-sm hidden"></i>
                    </div>
                </div>
            </div>
        </div>
        <div class="p-6 border-t border-gray-100 sticky bottom-0 bg-white">
            <div class="flex items-center justify-between">
                <p class="text-sm text-gray-600"><span id="selectedCount">0</span> beneficiarios seleccionados</p>
                <div class="flex items-center space-x-3">
                    <button type="button" onclick="closeBeneficiaryModal()" class="px-4 py-2 text-sm font-medium text-gray-700 bg-gray-100 hover:bg-gray-200 rounded-lg transition-colors">
                        Cancelar
                    </button>
                    <button type="button" onclick="addSelectedBeneficiaries()" class="px-4 py-2 text-sm font-medium text-white bg-[#8a4534] hover:bg-[#a05240] rounded-lg transition-colors">
                        Agregar Seleccionados
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="{% static 'src/js/projects.js' %}"></script>
<script>
// Beneficiarios seleccionados
let selectedBeneficiaries = [];

// Abrir modal de beneficiarios
function openBeneficiaryModal() {
    document.getElementById('beneficiaryModal').classList.remove('hidden');
}

// Cerrar modal de beneficiarios
function closeBeneficiaryModal() {
    document.getElementById('beneficiaryModal').classList.add('hidden');
}

// Toggle selección de beneficiario
function toggleBeneficiary(element) {
    const name = element.querySelector('.font-medium').textContent;
    const dpi = element.querySelector('.text-gray-500').textContent.replace('DPI: ', '');
    const initials = element.querySelector('.rounded-full span').textContent;
    
    const checkbox = element.querySelector('.checkbox-indicator');
    const checkIcon = checkbox.querySelector('.fa-check');
    
    if (selectedBeneficiaries.find(b => b.dpi === dpi)) {
        // Deseleccionar
        selectedBeneficiaries = selectedBeneficiaries.filter(b => b.dpi !== dpi);
        checkbox.classList.remove('bg-[#8a4534]', 'border-[#8a4534]');
        checkbox.classList.add('border-gray-300');
        checkIcon.classList.add('hidden');
    } else {
        // Seleccionar
        selectedBeneficiaries.push({ name, dpi, initials });
        checkbox.classList.add('bg-[#8a4534]', 'border-[#8a4534]');
        checkbox.classList.remove('border-gray-300');
        checkIcon.classList.remove('hidden');
    }
    
    document.getElementById('selectedCount').textContent = selectedBeneficiaries.length;
}

// Filtrar beneficiarios
function filterBeneficiaries() {
    const searchTerm = document.getElementById('beneficiarySearch').value.toLowerCase();
    const items = document.querySelectorAll('#beneficiariesList .beneficiary-item');
    
    items.forEach(item => {
        const name = item.querySelector('.font-medium').textContent.toLowerCase();
        const dpi = item.querySelector('.text-gray-500').textContent.toLowerCase();
        
        if (name.includes(searchTerm) || dpi.includes(searchTerm)) {
            item.classList.remove('hidden');
        } else {
            item.classList.add('hidden');
        }
    });
}

// Agregar beneficiarios seleccionados
function addSelectedBeneficiaries() {
    const list = document.getElementById('selectedBeneficiariesList');
    
    if (selectedBeneficiaries.length === 0) {
        return;
    }
    
    list.innerHTML = selectedBeneficiaries.map(b => `
        <div class="beneficiary-selected flex items-center justify-between bg-gray-50 rounded-lg p-3" data-dpi="${b.dpi}">
            <div class="flex items-center space-x-3">
                <div class="w-10 h-10 rounded-full bg-gradient-to-br from-[#8a4534] to-[#334e76] flex items-center justify-center text-white text-sm font-semibold">
                    <span>${b.initials}</span>
                </div>
                <div>
                    <p class="font-medium text-gray-900">${b.name}</p>
                    <p class="text-sm text-gray-500">DPI: ${b.dpi}</p>
                </div>
            </div>
            <button type="button" onclick="removeBeneficiary('${b.dpi}')" class="text-red-500 hover:text-red-700 transition-colors">
                <i class="fas fa-times text-lg"></i>
            </button>
        </div>
    `).join('');
    
    closeBeneficiaryModal();
}

// Eliminar beneficiario de la lista
function removeBeneficiary(dpi) {
    selectedBeneficiaries = selectedBeneficiaries.filter(b => b.dpi !== dpi);
    
    const element = document.querySelector(`.beneficiary-selected[data-dpi="${dpi}"]`);
    if (element) {
        element.remove();
    }
    
    // Si no hay beneficiarios, mostrar mensaje
    if (selectedBeneficiaries.length === 0) {
        document.getElementById('selectedBeneficiariesList').innerHTML = `
            <div class="text-center text-gray-500 py-8">
                <i class="fas fa-users text-4xl mb-2"></i>
                <p>No hay beneficiarios seleccionados</p>
                <p class="text-sm">Haga clic en "Agregar Beneficiario" para seleccionar beneficiarios del sistema</p>
            </div>
        `;
    }
}
</script>
{% endblock %}
